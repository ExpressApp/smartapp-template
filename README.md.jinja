# {{bot_project_name}}

Смартапп создан на базе шаблона [smartapp-template](https://github.com/ExpressApp/smartapp-template).

## Описание

{{bot_description}}

## Сборка смартаппа
Перед сборкой Docker образа происходит распаковка билда фронта в директорию `app/smartapp_files`.
Для этого необходимо добавить переменные окружения пайплайнов в `Settings -> CI/CD -> Variables`
 * `SMARTAPP_GITLAB_ID` - числовой id репозитория фронта на GitLab
 * `SMARTAPP_PACKAGE_NAME` - название package registry билда фронта
 * `SMARTAPP_API_READ_TOKEN` - токен доступа для скачивания билда из репозитория фронта

При этом будет загружен самый свежий по дате билд. Для другой сортировки билдов можно использовать
параметр `--sort-strategy` (см. скрипт `get_latest_frontend_tag.py`)

Для задания кастомной версии билда фронта можно установить переменную `SMARTAPP_TAG` перед
запуском пайплайна.

Собранные версии фронта и бэка доступны в выводе джобы `build`.

## Деплой на наши сервера
Если необходимо создать несколько инстансов на деве, в `.gitlab-ci.yml` продублируйте
джобы `deploy.botstest` и `deploy.botstest.stop` с новыми названиями и задайте уникальное
значение `CONTAINER_PREFIX` в блоке `variables`. Теперь новые инстансы доступны по новой
ссылке с заданным префиксом в конце (полную ссылку можно увидеть в выводе джобы деплоя).

## Инструкция по развёртыванию {{bot_project_name}}

**NOTE**: *Для развёртывания нескольких смартаппов на сервере используйте
продвинутый вариант инструкции: [advanced-deploy.md](advanced-deploy.md).*

1. Воспользуйтесь инструкцией [Руководство
   администратора](https://express.ms/admin_guide.pdf) `-> Эксплуатация корпоративного
   сервера -> Управление контактами -> Чат-боты`, чтобы создать бота в панели
   администратора eXpress.
2. Получите `secret_key` и `bot_id`, нажав на имя созданного бота.
3. Получите `cts_host` в строке браузера в панели администратора.


4. Скачайте репозиторий на сервер:

```bash
git clone <THIS_REPOSITORY> /opt/express/bots/{{bot_project_name}}
cd /opt/express/bots/{{bot_project_name}}
```

5. Отредактируйте `docker-compose.yml`, заменив `cts_host`, `secret_key` и `bot_id` на реальные значения.


6. Запустите контейнеры командой:

```bash
docker-compose up -d
```

7. Убедитесь, что в логах нет ошибок.

```bash
docker-compose logs
```

8. Найдите смартапп через вкладку "Smart Apps" (3x3 точек под чемоднаном).
